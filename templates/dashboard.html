<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Collaborator Audit Dashboard</title>
    <meta name="csrf-token" content="{{ csrf_token }}" />
    <style>
      :root {
        --ink: #15233b;
        --muted: #5d6c83;
        --line: #d8e1ef;
        --surface: #ffffff;
        --surface-soft: #f3f7fc;
        --accent: #0d74dd;
        --accent-strong: #0a5ab0;
        --danger: #c03434;
        --ok: #1d9157;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Avenir Next", "Trebuchet MS", "Segoe UI", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(900px 450px at 95% 0%, #dcecff 0%, transparent 45%),
          radial-gradient(900px 450px at 0% 100%, #dff4ee 0%, transparent 45%),
          linear-gradient(180deg, #eef3fb 0%, #f6f9fe 100%);
      }
      .wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 22px;
      }
      .hero {
        display: grid;
        gap: 14px;
        margin-bottom: 14px;
      }
      .title {
        margin: 0;
        font-size: clamp(24px, 4vw, 34px);
        letter-spacing: -0.01em;
      }
      .subtitle {
        margin: 0;
        color: var(--muted);
        max-width: 72ch;
      }
      .panel {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 14px 28px rgba(20, 40, 72, 0.07);
      }
      .topbar,
      .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }
      .topbar {
        justify-content: space-between;
        margin-bottom: 12px;
      }
      .filters { margin-bottom: 10px; }
      .stack {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: var(--surface-soft);
        color: #2c3f61;
        font-size: 13px;
      }
      .field,
      select {
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 9px 11px;
        background: white;
        color: var(--ink);
      }
      .field {
        min-width: 260px;
        flex: 1;
      }
      .btn {
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 9px 13px;
        background: white;
        color: var(--ink);
        cursor: pointer;
      }
      .btn:hover { border-color: #aebfd8; }
      .btn-primary {
        border-color: var(--accent);
        color: white;
        background: linear-gradient(180deg, #2f8bf9, var(--accent));
      }
      .btn-primary:hover { background: linear-gradient(180deg, #2a7ce0, var(--accent-strong)); }
      .btn-danger {
        border-color: var(--danger);
        background: var(--danger);
        color: white;
      }
      .btn[disabled] {
        opacity: 0.55;
        cursor: not-allowed;
      }
      .status {
        margin: 10px 0;
        font-size: 14px;
      }
      .muted { color: var(--muted); }
      #status.good { color: var(--ok); }
      #status.bad { color: var(--danger); }
      .table-wrap {
        margin-top: 8px;
        overflow-x: auto;
        border: 1px solid var(--line);
        border-radius: 12px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 760px;
      }
      thead {
        background: #f3f7fd;
      }
      th,
      td {
        border-bottom: 1px solid var(--line);
        padding: 10px;
        text-align: left;
        vertical-align: middle;
      }
      tbody tr:hover {
        background: #f7fbff;
      }
      .permission {
        display: inline-flex;
        border: 1px solid #ccdaef;
        background: #edf4ff;
        color: #24466f;
        border-radius: 999px;
        font-size: 12px;
        padding: 4px 9px;
      }
      .empty {
        padding: 22px;
        text-align: center;
        color: var(--muted);
      }
      .modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(6, 17, 33, 0.5);
        padding: 16px;
      }
      .modal.show { display: flex; }
      .modal-card {
        width: min(520px, 100%);
        background: white;
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 16px;
      }
      .modal-card h2 {
        margin: 0 0 8px;
      }
      @media (max-width: 760px) {
        .wrap {
          padding: 14px;
        }
        .panel {
          padding: 12px;
          border-radius: 12px;
        }
        .topbar,
        .filters,
        .stack {
          align-items: stretch;
        }
        .topbar > .btn,
        .filters > .btn,
        .stack > .btn,
        .stack > .pill {
          width: 100%;
          justify-content: center;
        }
        .field,
        select,
        .btn {
          min-width: 100%;
          width: 100%;
          min-height: 44px;
        }
        .table-wrap {
          border: 0;
          background: transparent;
          overflow: visible;
        }
        table {
          min-width: 100%;
        }
        thead {
          display: none;
        }
        tbody tr {
          display: grid;
          grid-template-columns: 1fr;
          gap: 6px;
          margin-bottom: 10px;
          padding: 10px;
          border: 1px solid var(--line);
          border-radius: 12px;
          background: white;
        }
        td {
          display: flex;
          gap: 8px;
          border: 0;
          padding: 0;
          align-items: center;
          min-height: 26px;
        }
        td[data-label]::before {
          content: attr(data-label);
          font-size: 12px;
          color: var(--muted);
          min-width: 86px;
        }
        td.checkbox-cell {
          padding-bottom: 2px;
        }
        td.checkbox-cell::before {
          content: "Select";
          font-size: 12px;
          color: var(--muted);
          min-width: 86px;
        }
        td.permission-cell {
          align-items: flex-start;
          flex-wrap: wrap;
        }
        #selection-count {
          width: 100%;
          text-align: left;
        }
      }
    </style>
  </head>
  <body>
    <main class="wrap">
      <section class="hero">
        <h1 class="title">Collaborator Audit Dashboard</h1>
        <p class="subtitle">Filter repositories, inspect collaborator permissions, and remove access in bulk with confirmation and server-side permission checks.</p>
      </section>

      <section class="panel">
        <div class="topbar">
          <form method="get" action="/dashboard" class="stack">
            <label class="pill"><input type="checkbox" name="ignore_forks" value="true" {% if ignore_forks %}checked{% endif %} /> Ignore forks</label>
            <label class="pill"><input type="checkbox" name="ignore_archived" value="true" {% if ignore_archived %}checked{% endif %} /> Ignore archived</label>
            <button class="btn" type="submit">Apply repository filters</button>
          </form>
          <button class="btn" id="logout-btn" type="button">Log out</button>
        </div>

        <div class="filters">
          <input id="search" class="field" type="search" placeholder="Search repository or username" />
          <select id="permission-filter">
            <option value="">All permissions</option>
            <option value="admin">admin</option>
            <option value="maintain">maintain</option>
            <option value="write">write</option>
            <option value="triage">triage</option>
            <option value="read">read</option>
          </select>
          <button class="btn btn-danger" id="remove-btn" disabled type="button">Remove selected</button>
          <span class="muted" id="selection-count">0 selected</span>
        </div>

        <div id="status" class="status muted"></div>

        <div class="table-wrap">
          <table id="rows-table">
            <thead>
              <tr>
                <th><input id="select-all" type="checkbox" /></th>
                <th>Repository</th>
                <th>Collaborator</th>
                <th>Permission</th>
              </tr>
            </thead>
            <tbody>
              {% for row in rows %}
              <tr data-repo="{{ row.repo }}" data-user="{{ row.collaborator }}" data-permission="{{ row.permission }}">
                <td class="checkbox-cell">
                  <input class="row-check" type="checkbox" value="{{ row.repo }}::{{ row.collaborator }}" data-repo="{{ row.repo }}" data-user="{{ row.collaborator }}" {% if !row.can_remove %}disabled{% endif %} />
                </td>
                <td data-label="Repository">{{ row.repo }}</td>
                <td data-label="Collaborator">{{ row.collaborator }}</td>
                <td class="permission-cell" data-label="Permission">
                  <span class="permission">{{ row.permission }}</span>
                  {% if !row.can_remove %}<span class="muted"> removal disabled</span>{% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% if rows.len() == 0 %}
          <p class="empty">No external collaborators found for your current filters.</p>
          {% endif %}
        </div>
      </section>
    </main>

    <div id="confirm-modal" class="modal" aria-hidden="true">
      <div class="modal-card">
        <h2>Confirm collaborator removal</h2>
        <p id="confirm-text" class="muted"></p>
        <div class="filters">
          <button class="btn" id="cancel-remove" type="button">Cancel</button>
          <button class="btn btn-danger" id="confirm-remove" type="button">Confirm removal</button>
        </div>
      </div>
    </div>

    <script>
      const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
      const searchInput = document.getElementById("search");
      const permissionFilter = document.getElementById("permission-filter");
      const selectAll = document.getElementById("select-all");
      const removeBtn = document.getElementById("remove-btn");
      const statusBox = document.getElementById("status");
      const selectionCount = document.getElementById("selection-count");
      const modal = document.getElementById("confirm-modal");
      const confirmText = document.getElementById("confirm-text");
      const confirmRemove = document.getElementById("confirm-remove");
      const cancelRemove = document.getElementById("cancel-remove");
      const logoutBtn = document.getElementById("logout-btn");

      function rowChecks() {
        return Array.from(document.querySelectorAll(".row-check"));
      }

      function visibleRows() {
        return Array.from(document.querySelectorAll("#rows-table tbody tr")).filter((row) => row.style.display !== "none");
      }

      function applyFilters() {
        const term = searchInput.value.trim().toLowerCase();
        const permission = permissionFilter.value;

        Array.from(document.querySelectorAll("#rows-table tbody tr")).forEach((row) => {
          const repo = row.dataset.repo.toLowerCase();
          const user = row.dataset.user.toLowerCase();
          const rowPermission = row.dataset.permission;

          const textMatch = !term || repo.includes(term) || user.includes(term);
          const permissionMatch = !permission || permission === rowPermission;
          row.style.display = textMatch && permissionMatch ? "" : "none";
        });

        syncSelectAllState();
      }

      function selectedItems() {
        return rowChecks()
          .filter((check) => check.checked && !check.disabled)
          .map((check) => ({ repo: check.dataset.repo, username: check.dataset.user }));
      }

      function updateSelectionUI() {
        const count = selectedItems().length;
        selectionCount.textContent = `${count} selected`;
        removeBtn.disabled = count === 0;
      }

      function syncSelectAllState() {
        const checks = visibleRows()
          .map((row) => row.querySelector(".row-check"))
          .filter((check) => check && !check.disabled);

        if (checks.length === 0) {
          selectAll.checked = false;
          selectAll.indeterminate = false;
          updateSelectionUI();
          return;
        }

        const selected = checks.filter((check) => check.checked).length;
        selectAll.checked = selected === checks.length;
        selectAll.indeterminate = selected > 0 && selected < checks.length;
        updateSelectionUI();
      }

      searchInput.addEventListener("input", applyFilters);
      permissionFilter.addEventListener("change", applyFilters);

      rowChecks().forEach((check) => {
        check.addEventListener("change", syncSelectAllState);
      });

      selectAll.addEventListener("change", () => {
        visibleRows().forEach((row) => {
          const check = row.querySelector(".row-check");
          if (check && !check.disabled) {
            check.checked = selectAll.checked;
          }
        });
        syncSelectAllState();
      });

      removeBtn.addEventListener("click", () => {
        const items = selectedItems();
        if (items.length === 0) return;
        confirmText.textContent = `You are removing ${items.length} collaborator assignment(s). This action cannot be undone.`;
        modal.classList.add("show");
      });

      cancelRemove.addEventListener("click", () => modal.classList.remove("show"));

      confirmRemove.addEventListener("click", async () => {
        const items = selectedItems();
        if (items.length === 0) {
          modal.classList.remove("show");
          return;
        }

        confirmRemove.disabled = true;
        statusBox.className = "status muted";
        statusBox.textContent = "Removing collaborators...";

        try {
          const response = await fetch("/remove", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": csrfToken
            },
            body: JSON.stringify({ items })
          });

          const payload = await response.json();
          const successCount = Array.isArray(payload.success) ? payload.success.length : 0;
          const failureCount = Array.isArray(payload.failed) ? payload.failed.length : 0;

          if (!response.ok) {
            throw new Error(payload.error || "Removal request failed");
          }

          statusBox.className = failureCount > 0 ? "status bad" : "status good";
          statusBox.textContent = `Removed ${successCount}. Failed ${failureCount}.`;

          if (successCount > 0) {
            payload.success.forEach((item) => {
              const selector = `tr[data-repo='${item.repo}'][data-user='${item.username}']`;
              const row = document.querySelector(selector);
              if (row) row.remove();
            });
          }

          syncSelectAllState();
        } catch (error) {
          statusBox.className = "status bad";
          statusBox.textContent = error.message || "Removal request failed";
        } finally {
          confirmRemove.disabled = false;
          modal.classList.remove("show");
        }
      });

      logoutBtn.addEventListener("click", async () => {
        await fetch("/logout", {
          method: "POST",
          headers: { "X-CSRF-Token": csrfToken }
        });
        window.location.href = "/";
      });

      applyFilters();
      updateSelectionUI();
    </script>
  </body>
</html>
